<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart City AI Traffic Junction</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --red: #ff2020; --yellow: #ffd700; --green: #00ff88;
    --red-glow: rgba(255,32,32,0.7); --yellow-glow: rgba(255,215,0,0.7); --green-glow: rgba(0,255,136,0.7);
    --panel: rgba(5,10,30,0.95); --accent: #00e5ff; --text: #c8e6ff;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#020812; font-family:'Share Tech Mono',monospace;
    color:var(--text); min-height:100vh; display:flex;
    flex-direction:column; align-items:center; overflow-x:hidden;
  }
  header {
    width:100%; padding:10px 24px;
    background:linear-gradient(90deg,#020812 0%,#0a1628 50%,#020812 100%);
    border-bottom:1px solid rgba(0,229,255,0.2);
    display:flex; align-items:center; justify-content:space-between;
  }
  header h1 { font-family:'Orbitron',monospace; font-size:0.95rem; letter-spacing:3px; color:var(--accent); text-shadow:0 0 20px rgba(0,229,255,0.5); }
  .status-bar { font-size:0.68rem; color:var(--green); letter-spacing:2px; animation:blink 2s infinite; }
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}

  .scene {
    position:relative; width:560px; height:560px; flex-shrink:0; margin:20px auto;
  }
  .ground { position:absolute; inset:0; background:#0a0f1a; border-radius:4px; overflow:hidden; }
  .ground::before {
    content:''; position:absolute; inset:0;
    background-image:linear-gradient(rgba(0,229,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.03) 1px,transparent 1px);
    background-size:40px 40px;
  }
  .road-north,.road-south { position:absolute; left:50%; transform:translateX(-50%); width:140px; background:#1c1c2e; z-index:1; }
  .road-north { top:0; height:calc(50% - 70px); }
  .road-south { bottom:0; height:calc(50% - 70px); }
  .road-west { position:absolute; top:50%; transform:translateY(-50%); height:140px; left:0; width:calc(50% - 70px); background:#1c1c2e; z-index:1; }
  .intersection-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:140px; height:140px; background:#1c1c2e; z-index:2; }
  .intersection-box::before { content:''; position:absolute; inset:0; background:repeating-linear-gradient(45deg,rgba(255,255,255,0.01) 0,rgba(255,255,255,0.01) 1px,transparent 1px,transparent 12px); }
  .center-line-v { position:absolute; left:50%; transform:translateX(-50%); width:3px; top:0; bottom:0; background:repeating-linear-gradient(to bottom,rgba(255,220,0,0.4) 0,rgba(255,220,0,0.4) 20px,transparent 20px,transparent 40px); }
  .center-line-h { position:absolute; top:50%; transform:translateY(-50%); height:3px; left:0; right:0; background:repeating-linear-gradient(to right,rgba(255,220,0,0.4) 0,rgba(255,220,0,0.4) 20px,transparent 20px,transparent 40px); }
  .edge-v-l { position:absolute; left:10px; top:0; bottom:0; width:2px; background:rgba(255,255,255,0.1); }
  .edge-v-r { position:absolute; right:10px; top:0; bottom:0; width:2px; background:rgba(255,255,255,0.1); }
  .edge-h-t { position:absolute; top:10px; left:0; right:0; height:2px; background:rgba(255,255,255,0.1); }
  .edge-h-b { position:absolute; bottom:10px; left:0; right:0; height:2px; background:rgba(255,255,255,0.1); }
  .crosswalk { position:absolute; display:flex; z-index:3; }
  .cw-stripe { background:rgba(255,255,255,0.14); margin:0 2px; }
  .road-glow { position:absolute; pointer-events:none; z-index:4; opacity:0; transition:opacity 0.6s; }
  .road-glow.active { opacity:1; }
  .dir-label { position:absolute; font-family:'Orbitron',monospace; font-size:0.5rem; letter-spacing:3px; color:rgba(0,229,255,0.4); z-index:5; }
  .data-overlay { position:absolute; bottom:8px; left:8px; z-index:15; font-size:0.55rem; color:rgba(0,229,255,0.5); letter-spacing:1px; line-height:1.6; }
  .data-overlay span { color:var(--accent); }
  .emergency-overlay { position:absolute; inset:0; z-index:20; pointer-events:none; border:2px solid transparent; border-radius:4px; transition:border-color 0.3s; }
  .emergency-overlay.active { border-color:rgba(255,80,0,0.5); box-shadow:inset 0 0 40px rgba(255,80,0,0.08); animation:emgborder 0.6s infinite alternate; }
  @keyframes emgborder{from{border-color:rgba(255,80,0,0.3)}to{border-color:rgba(255,80,0,0.8)}}

  /* Traffic light */
  .traffic-light-wrap { position:absolute; z-index:10; display:flex; flex-direction:column; align-items:center; }
  .tl-pole { width:5px; background:linear-gradient(to right,#2a2a3a,#3a3a4a,#2a2a3a); border-radius:3px; }
  .tl-arm { height:5px; background:linear-gradient(to bottom,#2a2a3a,#3a3a4a,#2a2a3a); border-radius:3px; position:absolute; }
  .tl-housing {
    background:linear-gradient(135deg,#1a1a2a 0%,#252535 50%,#1a1a2a 100%);
    border:1px solid #333; border-radius:7px; padding:7px 5px;
    display:flex; flex-direction:column; gap:5px; align-items:center;
    box-shadow:2px 2px 12px rgba(0,0,0,0.8),inset 0 1px 0 rgba(255,255,255,0.05);
    position:relative;
  }
  .tl-housing::before { content:''; position:absolute; top:2px; left:2px; right:2px; height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent); }
  .tl-lens { width:20px; height:20px; border-radius:50%; position:relative; transition:background 0.4s,box-shadow 0.4s; border:1px solid rgba(0,0,0,0.5); }
  .tl-lens::after { content:''; position:absolute; top:3px; left:3px; width:5px; height:5px; border-radius:50%; background:rgba(255,255,255,0.2); }
  .tl-lens.red-off{background:#3a0a0a;box-shadow:none} .tl-lens.yellow-off{background:#2a2200;box-shadow:none} .tl-lens.green-off{background:#001a0a;box-shadow:none}
  .tl-lens.red-on{background:var(--red);box-shadow:0 0 14px 4px var(--red-glow),0 0 28px 8px rgba(255,32,32,0.3)}
  .tl-lens.yellow-on{background:var(--yellow);box-shadow:0 0 14px 4px var(--yellow-glow),0 0 28px 8px rgba(255,215,0,0.3)}
  .tl-lens.green-on{background:var(--green);box-shadow:0 0 14px 4px var(--green-glow),0 0 28px 8px rgba(0,255,136,0.3)}

  /* Stats bar */
  .stats-bar {
    display:flex; gap:20px; justify-content:center; font-size:0.6rem;
    color:rgba(200,230,255,0.5); padding:8px 20px;
    border-top:1px solid rgba(0,229,255,0.08); width:100%;
    letter-spacing:1px;
  }
  .stat { display:flex; flex-direction:column; align-items:center; gap:2px; }
  .stat-val { font-family:'Orbitron',monospace; font-size:0.8rem; color:var(--accent); }
  .stat-val.green-val { color:var(--green); }
  .stat-val.yellow-val { color:var(--yellow); }
  .stat-val.red-val { color:var(--red); }

  .scanlines { position:fixed; inset:0; pointer-events:none; z-index:100; background:repeating-linear-gradient(to bottom,transparent 0px,transparent 3px,rgba(0,0,0,0.05) 3px,rgba(0,0,0,0.05) 4px); }
</style>
</head>
<body>
<div class="scanlines"></div>
<header>
  <h1>‚¨° SMART CITY AI TRAFFIC JUNCTION</h1>
  <div class="status-bar" id="status-bar">‚óè SYSTEM ONLINE ¬∑ ADAPTIVE MODE</div>
</header>

<div class="scene" id="scene">
  <div class="ground">
    <div class="road-north"><div class="center-line-v"></div><div class="edge-v-l"></div><div class="edge-v-r"></div></div>
    <div class="road-south"><div class="center-line-v"></div><div class="edge-v-l"></div><div class="edge-v-r"></div></div>
    <div class="road-west"><div class="center-line-h"></div><div class="edge-h-t"></div><div class="edge-h-b"></div></div>
    <div class="intersection-box"></div>

    <!-- Crosswalks -->
    <div class="crosswalk" style="left:calc(50% - 70px);top:calc(50% - 80px);width:140px;height:14px;">
      <div class="cw-stripe" style="width:12px;height:14px"></div><div class="cw-stripe" style="width:12px;height:14px"></div>
      <div class="cw-stripe" style="width:12px;height:14px"></div><div class="cw-stripe" style="width:12px;height:14px"></div>
      <div class="cw-stripe" style="width:12px;height:14px"></div><div class="cw-stripe" style="width:12px;height:14px"></div>
      <div class="cw-stripe" style="width:12px;height:14px"></div>
    </div>
    <div class="crosswalk" style="left:calc(50% - 70px);top:calc(50% + 66px);width:140px;height:14px;">
      <div class="cw-stripe" style="width:12px;height:14px"></div><div class="cw-stripe" style="width:12px;height:14px"></div>
      <div class="cw-stripe" style="width:12px;height:14px"></div><div class="cw-stripe" style="width:12px;height:14px"></div>
      <div class="cw-stripe" style="width:12px;height:14px"></div><div class="cw-stripe" style="width:12px;height:14px"></div>
      <div class="cw-stripe" style="width:12px;height:14px"></div>
    </div>
    <div class="crosswalk" style="left:calc(50% - 80px);top:calc(50% - 70px);width:14px;height:140px;flex-direction:column;">
      <div class="cw-stripe" style="height:12px;width:14px"></div><div class="cw-stripe" style="height:12px;width:14px"></div>
      <div class="cw-stripe" style="height:12px;width:14px"></div><div class="cw-stripe" style="height:12px;width:14px"></div>
      <div class="cw-stripe" style="height:12px;width:14px"></div><div class="cw-stripe" style="height:12px;width:14px"></div>
      <div class="cw-stripe" style="height:12px;width:14px"></div>
    </div>

    <!-- Road glows -->
    <div class="road-glow" id="glow-north" style="left:calc(50% - 70px);top:0;width:140px;height:calc(50% - 70px);background:linear-gradient(to bottom,rgba(0,255,136,0.05),rgba(0,255,136,0.01))"></div>
    <div class="road-glow" id="glow-south" style="left:calc(50% - 70px);top:calc(50% + 70px);width:140px;bottom:0;height:calc(50% - 70px);background:linear-gradient(to top,rgba(0,255,136,0.05),rgba(0,255,136,0.01))"></div>
    <div class="road-glow" id="glow-west" style="top:calc(50% - 70px);left:0;width:calc(50% - 70px);height:140px;background:linear-gradient(to right,rgba(0,255,136,0.05),rgba(0,255,136,0.01))"></div>

    <div class="dir-label" style="top:8px;left:50%;transform:translateX(-50%)">N</div>
    <div class="dir-label" style="bottom:8px;left:50%;transform:translateX(-50%)">S</div>
    <div class="dir-label" style="left:8px;top:50%;transform:translateY(-50%)">W</div>

    <div class="data-overlay">
      AI CTRL v2.0 &nbsp;|&nbsp; MODE: <span id="mode-label">ADAPTIVE</span><br>
      PHASE: <span id="phase-label-data">INIT</span> &nbsp;|&nbsp; TIMER: <span id="timer-data">--</span>
    </div>
    <div class="emergency-overlay" id="emg-overlay"></div>
    <div id="vehicles"></div>
  </div>

  <!-- Traffic lights -->
  <div class="traffic-light-wrap" id="tl-north" style="left:calc(50% + 74px);top:calc(50% - 138px)">
    <div style="position:relative">
      <div class="tl-arm" style="width:44px;right:0;top:28px"></div>
      <div class="tl-housing">
        <div class="tl-lens red-off" id="r-north"></div>
        <div class="tl-lens yellow-off" id="y-north"></div>
        <div class="tl-lens green-off" id="g-north"></div>
      </div>
      <div class="tl-pole" style="height:55px;margin:0 auto"></div>
    </div>
  </div>
  <div class="traffic-light-wrap" id="tl-south" style="left:calc(50% - 100px);top:calc(50% + 62px)">
    <div style="position:relative">
      <div class="tl-arm" style="width:44px;left:0;top:28px"></div>
      <div class="tl-housing">
        <div class="tl-lens red-off" id="r-south"></div>
        <div class="tl-lens yellow-off" id="y-south"></div>
        <div class="tl-lens green-off" id="g-south"></div>
      </div>
      <div class="tl-pole" style="height:55px;margin:0 auto"></div>
    </div>
  </div>
  <div class="traffic-light-wrap" id="tl-west" style="left:calc(50% - 154px);top:calc(50% - 112px)">
    <div style="position:relative">
      <div class="tl-housing">
        <div class="tl-lens red-off" id="r-west"></div>
        <div class="tl-lens yellow-off" id="y-west"></div>
        <div class="tl-lens green-off" id="g-west"></div>
      </div>
      <div class="tl-pole" style="height:36px;margin:0 auto"></div>
    </div>
  </div>
</div>

<!-- Stats bar -->
<div class="stats-bar">
  <div class="stat"><div class="stat-val" id="stat-green-road">NORTH</div><div>ACTIVE ROAD</div></div>
  <div class="stat"><div class="stat-val" id="stat-timer">--</div><div>TIME LEFT</div></div>
  <div class="stat"><div class="stat-val" id="stat-cycles">0</div><div>CYCLES</div></div>
  <div class="stat"><div class="stat-val" id="stat-vehicles">0</div><div>VEHICLES</div></div>
  <div class="stat"><div class="stat-val" id="stat-mode">ADAPTIVE</div><div>MODE</div></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CORE ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROADS = ['north','south','west'];
const YELLOW_DUR = 2500;
const MIN_GREEN = 5000;
const MAX_GREEN = 18000;

let state = { currentGreen:null, phase:'green', phaseStart:0, phaseDuration:0, emergency:null, emergencyHandled:false };
let volumes = { north:5, south:5, west:5 };
let cycleCount = 0, phaseTimer = null;
let simStart = Date.now();

function getGreenDuration(road) {
  const v = volumes[road]||5;
  return Math.round(MIN_GREEN + ((v-1)/9)*(MAX_GREEN-MIN_GREEN));
}

function setLight(road, colorState) {
  ['r','y','g'].forEach((c,i) => {
    const colors=['red','yellow','green'];
    const el = document.getElementById(`${c}-${road}`);
    if(!el) return;
    el.className = `tl-lens ${colorState===colors[i]?colors[i]+'-on':colors[i]+'-off'}`;
  });
  const glow = document.getElementById(`glow-${road}`);
  if(glow) glow.className = `road-glow ${colorState==='green'?'active':''}`;
}

function renderLights() {
  ROADS.forEach(road => {
    if(road===state.currentGreen) setLight(road, state.phase==='yellow'?'yellow':'green');
    else setLight(road,'red');
  });
  updateStats();
}

function updateStats() {
  const now = Date.now();
  const rem = Math.max(0, state.phaseDuration-(now-state.phaseStart));
  const remS = (rem/1000).toFixed(1)+'s';
  document.getElementById('stat-green-road').textContent = (state.currentGreen||'--').toUpperCase();
  document.getElementById('stat-green-road').className = `stat-val ${state.phase==='green'?'green-val':state.phase==='yellow'?'yellow-val':'red-val'}`;
  document.getElementById('stat-timer').textContent = remS;
  document.getElementById('stat-cycles').textContent = cycleCount;
  document.getElementById('stat-vehicles').textContent = vehicles.length;
  document.getElementById('stat-mode').textContent = state.emergency?'EMERGENCY':'ADAPTIVE';
  document.getElementById('timer-data').textContent = remS;
  document.getElementById('mode-label').textContent = state.emergency?'EMERGENCY':'ADAPTIVE';
  document.getElementById('phase-label-data').textContent = `${(state.currentGreen||'').toUpperCase()} ${state.phase.toUpperCase()}`;
  document.getElementById('status-bar').textContent = state.emergency?`üö® EMERGENCY ¬∑ ${state.emergency.toUpperCase()} PRIORITY`:'‚óè SYSTEM ONLINE ¬∑ ADAPTIVE MODE';

  // Post status back to Streamlit parent
  try {
    window.parent.postMessage({
      type:'trafficStatus',
      currentGreen: state.currentGreen,
      phase: state.phase,
      timeRemaining: Math.round(rem/1000),
      cycleCount,
      emergency: state.emergency,
      vehicleCount: vehicles.length
    },'*');
  } catch(e){}
}

function getNextRoad() {
  if(state.emergency && !state.emergencyHandled) return state.emergency;
  const candidates = ROADS.filter(r=>r!==state.currentGreen);
  return candidates.reduce((a,b)=>volumes[b]>volumes[a]?b:a);
}

function startGreen(road) {
  if(state.emergency===road) state.emergencyHandled=true;
  state.currentGreen=road; state.phase='green';
  state.phaseStart=Date.now();
  state.phaseDuration=(state.emergency&&state.emergencyHandled&&state.emergency===road)
    ? getGreenDuration(road)*0.6 : getGreenDuration(road);
  renderLights();
  clearTimeout(phaseTimer);
  phaseTimer=setTimeout(startYellow, state.phaseDuration);
}

function startYellow() {
  state.phase='yellow'; state.phaseStart=Date.now(); state.phaseDuration=YELLOW_DUR;
  renderLights();
  clearTimeout(phaseTimer);
  phaseTimer=setTimeout(startNext, YELLOW_DUR);
}

function startNext() {
  state.phase='transition';
  ROADS.forEach(r=>setLight(r,'red'));
  clearTimeout(phaseTimer);
  phaseTimer=setTimeout(()=>{ cycleCount++; startGreen(getNextRoad()); }, 300);
}

// ‚îÄ‚îÄ VEHICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let vehicles = [], vidCounter = 0;
const CAR_COLORS = ['#c0392b','#2980b9','#27ae60','#f39c12','#8e44ad','#16a085','#d35400','#e74c3c','#3498db','#1abc9c'];
const vehicleContainer = document.getElementById('vehicles');

function spawnVehicle(road) {
  const W=560, H=560, cx=W/2, cy=H/2;
  const isEmg = state.emergency===road;
  const color = isEmg?'#ff5000':CAR_COLORS[Math.floor(Math.random()*CAR_COLORS.length)];
  const spd = isEmg?3.2:1.1+Math.random()*0.9;
  let x,y,dx,dy,w,h;
  if(road==='north'){x=cx+15+Math.random()*25;y=-20;dx=0;dy=spd;w=16;h=28;}
  else if(road==='south'){x=cx-50+Math.random()*18;y=H+20;dx=0;dy=-spd;w=16;h=28;}
  else{x=-20;y=cy-50+Math.random()*18;dx=spd;dy=0;w=28;h=16;}

  const el = document.createElement('div');
  el.style.cssText=`position:absolute;width:${w}px;height:${h}px;left:${x}px;top:${y}px;border-radius:3px;background:${color};z-index:8;box-shadow:${isEmg?'0 0 12px rgba(255,80,0,0.8)':'0 0 4px rgba(0,0,0,0.6)'};`;
  if(isEmg) el.style.border='1px solid #ff8040';
  const ws=document.createElement('div');
  if(road==='north') ws.style.cssText='position:absolute;top:3px;left:2px;width:12px;height:7px;background:rgba(150,220,255,0.3);border-radius:2px;';
  else if(road==='south') ws.style.cssText='position:absolute;bottom:3px;left:2px;width:12px;height:7px;background:rgba(150,220,255,0.3);border-radius:2px;';
  else ws.style.cssText='position:absolute;left:3px;top:2px;width:7px;height:12px;background:rgba(150,220,255,0.3);border-radius:2px;';
  el.appendChild(ws);
  vehicleContainer.appendChild(el);
  vehicles.push({el,x,y,dx,dy,road,stopped:false});
}

const STOP = { north:{axis:'y',stop:560/2-82,dir:1}, south:{axis:'y',stop:560/2+82-28,dir:-1}, west:{axis:'x',stop:560/2-82,dir:1} };

function isAtStop(v) {
  const sl=STOP[v.road];
  if(sl.axis==='y') return sl.dir===1? v.y+28>=sl.stop : v.y<=sl.stop;
  return v.x+28>=sl.stop;
}
function isOOB(v){ return v.x>600||v.x<-60||v.y>600||v.y<-60; }

function updateVehicles() {
  vehicles.forEach(v => {
    const light = v.road===state.currentGreen?(state.phase==='yellow'?'yellow':'green'):'red';
    if(light==='red' && isAtStop(v)) v.stopped=true;
    else if(light!=='red') v.stopped=false;
    if(!v.stopped){ const sm=light==='yellow'?0.5:1; v.x+=v.dx*sm; v.y+=v.dy*sm; v.el.style.left=v.x+'px'; v.el.style.top=v.y+'px'; }
  });
  vehicles = vehicles.filter(v=>{ if(isOOB(v)){v.el.remove();return false;}return true; });
}

setInterval(()=>{
  ROADS.forEach(road=>{
    const vol=volumes[road];
    if(Math.random()<vol/10*0.35 && vehicles.filter(v=>v.road===road).length<vol+2) spawnVehicle(road);
  });
},1300);

setInterval(updateVehicles,16);
setInterval(updateStats,200);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STREAMLIT ‚Üî IFRAME MESSAGE API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('message', function(e) {
  const d = e.data;
  if(!d || typeof d!=='object') return;

  // Volume updates
  if(d.type==='setVolume') {
    if(d.road && d.value!==undefined) volumes[d.road]=d.value;
  }

  // Emergency trigger
  if(d.type==='setEmergency') {
    if(d.road) {
      state.emergency = d.road;
      state.emergencyHandled = false;
      document.getElementById('emg-overlay').className='emergency-overlay active';
      if(state.currentGreen!==d.road){ clearTimeout(phaseTimer); startYellow(); }
    } else {
      // clear
      state.emergency=null; state.emergencyHandled=false;
      document.getElementById('emg-overlay').className='emergency-overlay';
    }
  }

  // Bulk config
  if(d.type==='config') {
    if(d.volumes) Object.assign(volumes, d.volumes);
    if(d.emergency!==undefined) {
      if(d.emergency) {
        state.emergency=d.emergency; state.emergencyHandled=false;
        document.getElementById('emg-overlay').className='emergency-overlay active';
        if(state.currentGreen!==d.emergency){ clearTimeout(phaseTimer); startYellow(); }
      } else {
        state.emergency=null; state.emergencyHandled=false;
        document.getElementById('emg-overlay').className='emergency-overlay';
      }
    }
  }
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
ROADS.forEach(r=>setLight(r,'red'));
setTimeout(()=>startGreen('north'),500);
</script>
</body>
</html>
